<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EventHub</title>
    <link rel="stylesheet" href="style3.css">
    <style>
        body { padding-top: 70px; }
        .dark-mode .table { color: #eee; }
        .dark-mode .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: var(--bs-table-striped-bg, rgba(255, 255, 255, 0.05));
        }
    </style>
</head>

<body class="bg-light">

    <script>
        if (localStorage.getItem('admin_logged_in') !== 'true') {
            alert('You must be logged in to view this page.');
            window.location.href = 'admin-login.html';
        }
    </script>

    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html" style="font-size: 30px;">EventHub</a>
            <button class="navbar-toggler" type="button" id="navbarToggle"><span>â˜°</span></button>
            <div class="navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html#events">Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">Contact</a></li>
                    <li class="nav-item"><a class="btn btn-outline-danger ms-2" id="logoutButton" href="admin-login.html">Logout</a></li>
                    <li class="nav-item ms-3">
                        <button id="darkModeToggle" class="btn btn-secondary btn-sm">ðŸŒ™ Dark Mode</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold">Admin Dashboard</h1>
            <a href="create-event.html" class="btn btn-primary fw-semibold">Create New Event</a>
        </div>

        <h2 id="welcomeMessage" class="fw-semibold fs-4 mb-3"></h2>

        <h2 class="fw-semibold fs-4 mb-3">My Events</h2>

        <div id="eventsContainer">
            </div>
 
     </div>
 
     <script>
         // Dark Mode Toggle
         const toggle = document.getElementById('darkModeToggle');
         toggle.addEventListener('click', () => {
             document.body.classList.toggle('dark-mode');
             toggle.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
         });

         // Logout functionality (clears all admin flags)
         const logoutButton = document.getElementById('logoutButton');
         if (logoutButton) {
             logoutButton.addEventListener('click', (e) => {
                 e.preventDefault(); 
                 localStorage.removeItem('admin_logged_in');
                 localStorage.removeItem('admin_name');
                 localStorage.removeItem('admin_email'); // Clear the email
                 alert("Logging out...");
                 window.location.href = 'admin-login.html'; 
             });
         }

         // REMOVED: The old form toggle logic is gone
     </script>

   <script>
        // Define our localStorage keys
        const PARTICIPANT_STORAGE_KEY = 'eventhub_participants';
        const EVENT_STORAGE_KEY = 'eventhub_events';

        // Get the currently logged-in admin's email
        const CURRENT_ADMIN_EMAIL = localStorage.getItem('admin_email');

        // Helper function to read all events from storage
        function readEventsStore() {
            try { return JSON.parse(localStorage.getItem(EVENT_STORAGE_KEY)) || []; }
            catch (e) { return []; }
        }

        // Helper function to read all participants from storage
        function readParticipantsStore() {
            try { return JSON.parse(localStorage.getItem(PARTICIPANT_STORAGE_KEY)) || {}; }
            catch (e) { return {}; }
        }

        function formatDate(iso) {
            try { return new Date(iso).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }); }
            catch (e) { return iso; }
        }
        
        function escapeHtml(str = '') {
            // Ensure str is a string, default to empty string if null/undefined
            return String(str || '')
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // --- UPDATED: Render Function ---
        // This now displays the new fields from create-event.html
        function render() {
            const allParticipants = readParticipantsStore();
            const allEvents = readEventsStore();
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '';

            const myEvents = allEvents.filter(ev => ev.adminEmail === CURRENT_ADMIN_EMAIL);

            if (myEvents.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">You have not created any events yet. Click "Create New Event" to get started.</p>';
                return;
            }

            myEvents.forEach(ev => {
                const participants = allParticipants[ev.id] || [];
                const card = document.createElement('div');
                card.className = 'card shadow-sm mb-4';
                
                // UPDATED to show new fields (description, time)
                card.innerHTML = `
                    <div class="card-header">
                        <h3 class="fw-semibold mb-0">${escapeHtml(ev.title)}</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${escapeHtml(ev.description)}</p> 
                        
                        <p><strong>When:</strong> ${escapeHtml(ev.date)} at ${escapeHtml(ev.time)}</p>
                        <p><strong>Where:</strong> ${escapeHtml(ev.location)}</p>
                        
                        <h5 class="mt-4 fw-semibold">Participants (${participants.length})</h5>
                        ${participants.length === 0 ? '<p class="text-muted">No participants have registered for this event yet.</p>' : `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Phone</th><th>Registered On</th></tr>
                                </thead>
                                <tbody>
                                    ${participants.map(p => `
                                        <tr>
                                            <td>${escapeHtml(p.name)}</td>
                                            <td>${escapeHtml(p.email)}</td>
                                            <td>${escapeHtml(p.phone || '')}</td>
                                            <td>${formatDate(p.registeredOn)}</td>
                                        </tr>`).join('') }
                                </tbody>
                            </table>
                        </div>
                        `}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // REMOVED: The old "Save New Event" form listener is gone

        // --- Run on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set personalized welcome message
            const adminName = localStorage.getItem('admin_name') || 'Admin';
            document.getElementById('welcomeMessage').textContent = `Welcome, ${adminName}!`;
            
            // Initial render of the dashboard
            render();
        });

        // Optional: subscribe to storage events so multiple tabs update
        window.addEventListener('storage', (e) => {
            if (e.key === PARTICIPANT_STORAGE_KEY || e.key === EVENT_STORAGE_KEY) {
                render();
            }
        });
   </script>
</body>
</html>
